# WorkFlow Hub Bot — Техническая документация

## Обзор проекта

Telegram-бот для автоматизации работы с поставщиками и процессами проработки продуктов.

---

## Архитектура

```
bot/
├── main.py              # Точка входа, настройка handlers и фоновых задач
├── config.py            # Конфигурация (.env)
├── handlers/            # Обработчики Telegram
├── services/            # Бизнес-логика
├── models/              # SQLAlchemy модели
├── keyboards/           # Telegram клавиатуры
files/                   # Шаблоны (Excel)
scripts/                 # Утилиты (connect_to_iiko.js)
```

---

## Google Sheets — Структура таблиц

### Лист: `Реестр_Поставщики`

| Колонка | Буква | Описание |
|---------|-------|----------|
| № п/п | A | Номер записи |
| ИНН | B | ИНН поставщика |
| КПП | C | КПП поставщика |
| Наименование | D | Название поставщика |
| Контактное лицо | E | ФИО контакта |
| Телефон | F | Телефон |
| Email | G | Email поставщика |
| Номенклатура | H | Название продукта |
| Ед. изм. | I | Единица измерения |
| Цена | J | Цена за единицу |
| Ссылка на папку | K | Google Drive папка |
| Статус СБ | L | Ответ службы безопасности |
| Статус ЭДО | M | Ответ от ЭДО |
| Статус Роуминг | N | Ответ на роуминг |
| Статус Документы | O | Ответ на документы |
| Дата создания | P | Дата добавления |
| Кто добавил | Q | Username добавившего |
| Тип | R | Тип поставщика |
| Код заявки | S | Уникальный код (ML-XXXXX) |
| Договор/Протокол | T | Ссылки на договор/протокол |

### Лист: `Реестр_Проработки`

| Колонка | Буква | Индекс | Описание |
|---------|-------|--------|----------|
| Дата создания | A | 0 | Дата |
| ID заявки | B | 1 | REQ-XXXXX |
| Тип заявки | C | 2 | Тип |
| SLA (дни) | D | 3 | Дней на выполнение |
| Дедлайн | E | 4 | Крайний срок |
| Поставщик | F | 5 | Название поставщика |
| ИНН | G | 6 | ИНН поставщика |
| Номенклатура | H | 7 | Название продукта от поставщика |
| Ед. изм. | I | 8 | Единица измерения |
| Цена поставщика | J | 9 | Цена нового продукта |
| Ссылка на папку | K | 10 | Google Drive папка заявки |
| Ссылка на сертификат | L | 11 | Google Drive ссылка |
| (резерв) | M-N | 12-13 | - |
| Ссылка на этикетку (OCR) | O | 14 | Google Drive ссылка |
| Кто занёс | P | 15 | Username создателя заявки |
| Статус | Q | 16 | Новая / В работе / Завершена |
| Наименование iiko | R | 17 | Выбранный продукт из iiko |
| Цена iiko | S | 18 | Средняя цена из OLAP |
| Ссылка на акт | T | 19 | Google Drive ссылка |
| Кто взял в работу | U | 20 | Username взявшего заявку |
| Результат проработки | V | 21 | "Подходит" / "Не подходит" + комментарий |
| Массовая проработка | W | 22 | "Да" / "Нет" |
| Вес с этикетки | X | 23 | Значение из ячейки C24 акта |
| Дата завершения | Y | 24 | Дата/время завершения заявки |

---

## Шаблон акта проработки

Файл: `files/ШАБЛОН АКТ ПРОРАБОТКИ.xlsx`

### Плейсхолдеры

| Плейсхолдер | Ячейка | Описание | Источник |
|-------------|--------|----------|----------|
| `{{id_item}}` | D3 | ID заявки | Реестр_Проработки.A |
| `{{user_name}}` | D2 | Кто взял в работу | Telegram username |
| `{{date}}` | C10 | Дата проработки | Текущая дата |
| `{{name_of_goods}}` | C13 | Товар поставщика | Реестр_Проработки.E |
| `{{partner}}` | C15 | Поставщик | Реестр_Проработки.C |
| `{{name_of_goods_from_iiko}}` | C18 | Продукт iiko | Выбор пользователя |
| `{{certificate}}` | C32 | Ссылка на сертификат | Реестр_Проработки.H |
| `{{OCR}}` | C33 | Ссылка на этикетку | Реестр_Проработки.I |
| `{{price_from_partner}}` | C50 | Цена поставщика | Реестр_Проработки.F |
| `{{price_from_iiko}}` | C51 | Цена из iiko | OLAP отчёт |
| `{{period_from_iiko}}` | D51 | Период расчёта цены | 7 дней по умолчанию |

---

## Модели данных (SQLite)

### User
- `telegram_id` — Telegram ID
- `company_id` — FK на Company
- `position_id` — FK на Position (опционально)
- `role` — ADMIN / EMPLOYEE
- `full_name` — Имя

### Company
- `name` — Название
- `invite_code` — Код приглашения
- `created_by` — Создатель

### CompanyIntegrations
- `company_id` — FK на Company
- `google_sheet_id` — ID Google таблицы
- `google_drive_folder_id` — ID корневой папки Drive
- `sheet_verified` — Проверен ли доступ
- `drive_verified` — Проверен ли доступ

### IikoProductCache
- `iiko_id` — ID продукта в iiko
- `name` — Название
- `name_lower` — Название в нижнем регистре (для поиска)
- `product_type` — GOODS / DISH / MODIFIER
- `main_unit` — Единица измерения
- `product_category` — Категория

### JoinRequest
- `telegram_id` — Кто подаёт заявку
- `company_id` — В какую компанию
- `status` — PENDING / APPROVED / REJECTED

---

## Сервисы

### iiko_service.py
- **Авторизация**: `_login_api()` / `_logout_api()` — обязательный flow
- **Продукты**: `get_products()` — список всех продуктов
- **Департаменты**: `get_departments()` — список департаментов
- **Фильтрация**: `get_active_ml_msk_departments()` — только "МЛ МСК" без "(закрыто)"
- **Цены**: `get_product_price()` — OLAP отчёт TRANSACTIONS
- **Синхронизация**: `sync_products_to_db()` — ежедневное обновление кеша

### act_generator.py
- **Копирование**: `copy_file_to_folder()` — копия шаблона в Drive
- **Заполнение**: `fill_act_template()` — замена плейсхолдеров через Sheets API
- **Генерация**: `generate_act()` — полный процесс

### google_sheets.py
- `get_new_development_requests()` — заявки со статусом "Новая"
- `update_development_request_for_work()` — обновление при взятии в работу
- `get_incomplete_suppliers()` — поставщики без договора
- `update_contract_info()` — запись ссылок на договор

### email_service.py
- Отправка писем через SMTP (Yandex)
- Шаблоны: СБ проверка, ЭДО, Роуминг, Документы, Договор

---

## Процессы

### 1. Регистрация пользователя
1. `/start` → показ клавиатуры
2. Присоединение по коду приглашения
3. Автоодобрение для суперадминов
4. Обычные пользователи ждут подтверждения

### 2. Добавление поставщика
1. Ввод данных (ИНН → автоподстановка через DaData)
2. Создание папки на Drive
3. Загрузка документов (сертификат, этикетка)
4. Отправка писем (СБ, ЭДО, роуминг, документы)
5. Запись в Реестр_Поставщики

### 3. Завершение заявки поставщика
1. Выбор из списка незавершённых (пустая колонка T)
2. Загрузка договора и протокола
3. Сохранение в Drive + письмо бухгалтеру
4. Обновление Реестр_Поставщики.T

### 4. Процесс проработки — Этап 1: Создание акта
1. "Выбрать заявку" → список из Реестр_Проработки (статус "Новая")
2. Поиск продукта в кеше iiko (регистронезависимый)
3. Получение цены через OLAP отчёт
4. Показ сводки: цена поставщика vs цена iiko
5. Создание акта (копия шаблона + заполнение)
6. Загрузка в папку заявки
7. Обновление Реестр_Проработки (P, Q, R, S, T)

### 5. Процесс проработки — Этап 2: Завершение

**UI изменения:**
- Кнопка "Процесс проработки" → "Проработки (Заявки)"
- Кнопка "Мои заявки в работе" → "Заявки в работе" (перенести в главное меню)

**Поток:**

1. **Вход**: Пользователь нажимает "Заявки в работе"
2. **Проверка**: Если нет заявок со статусом "В работе" для этого пользователя → уведомление "Нет активных заявок, сначала выберите заявку"
3. **Выбор заявки**: Если есть — показать список для выбора
4. **Загрузка фото**:
   - Пользователь отправляет фото (неограниченное количество)
   - Фото загружаются в папку заявки на Google Drive
   - Фото добавляются в акт (лист "Фото"): ссылка + миниатюра через `=IMAGE(url)`
   - Кнопка "✅ Завершить загрузку фото"
5. **Результат проработки**:
   - Inline-кнопки: "✅ Подходит" / "❌ Не подходит"
   - Опциональный комментарий (текстовое поле или пропуск)
6. **Массовая проработка** (только если "Подходит"):
   - Inline-кнопки: "Да" / "Нет"
7. **Получение данных из акта**:
   - Читаем ячейку **C24** (вес продукта с этикетки)
8. **Обновление Реестр_Проработки**:
   - Q (16): Статус → "Завершена"
   - V (21): Результат ("Подходит" / "Не подходит" + комментарий)
   - W (22): Массовая проработка ("Да" / "Нет" / пусто)
   - X (23): Вес с этикетки (из C24 акта)
   - Y (24): Дата завершения
9. **Генерация PDF**:
   - Экспорт акта из Google Sheets в PDF
10. **Отправка email поставщику**:
    - Получатель: email из Реестр_Поставщики (колонка E) по ИНН поставщика
    - Тело: краткий результат + информация о массовой проработке
    - Вложение: PDF акта

**Технические детали:**

| Компонент | Реализация |
|-----------|------------|
| Фото в лист "Фото" | Ссылка в колонке A, `=IMAGE(url)` в колонке B |
| PDF экспорт | Google Drive API: `export` с mimeType `application/pdf` |
| Email поставщика | Поиск в Реестр_Поставщики по ИНН (колонка B → E) |
| C24 акта | Google Sheets API: `spreadsheets.values.get` |

---

## Фоновые задачи (APScheduler)

1. **sync_iiko_job** — синхронизация продуктов iiko (каждые 24 часа)
2. **check_email_replies** — проверка ответов на письма (каждые 5 минут)

---

## Конфигурация (.env)

```env
# Telegram
TELEGRAM_BOT_TOKEN=
SUPERADMIN_IDS=321862714

# Google
GOOGLE_DRIVE_CREDENTIALS_FILE=credentials.json
GOOGLE_DRIVE_FOLDER_ID=

# Email (Gmail)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=465
SMTP_EMAIL=oz@mnogolososya.ru
SMTP_PASSWORD=
GMAIL_IMAP_HOST=imap.gmail.com
GMAIL_IMAP_PORT=993
GMAIL_IMAP_USER=oz@mnogolososya.ru
GMAIL_IMAP_PASSWORD=

# iiko
IIKO_BASE_URL=https://mnogo-lososya-centralniy-of-co.iiko.it:443/resto/api
IIKO_LOGIN=api_reader
IIKO_PASSWORD=

# Database
DATABASE_URL=sqlite+aiosqlite:///./data/bot.db
```

---

## TODO

- [x] ~~Этап 2: Завершение проработки~~ → план составлен
- [x] ~~Заполнение всех плейсхолдеров в акте~~
- [x] ~~Разделение "Ответственный" на "Кто занёс" и "Кто взял в работу"~~

### Этап 2: Завершение проработки (В процессе)

- [ ] Переименование кнопок UI
- [ ] Кнопка "Заявки в работе" в главном меню
- [ ] Получение заявок пользователя со статусом "В работе"
- [ ] Загрузка фото + запись в лист "Фото" акта
- [ ] Вопрос "Подходит / Не подходит" + комментарий
- [ ] Вопрос "Массовая проработка" (Да/Нет)
- [ ] Чтение C24 из акта
- [ ] Обновление колонок V, W, X, Y
- [ ] Изменение статуса на "Завершена"
- [ ] Экспорт акта в PDF
- [ ] Отправка email поставщику с PDF
