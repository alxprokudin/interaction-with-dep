# WorkFlow Hub Bot — Техническая документация

## Обзор проекта

Telegram-бот для автоматизации работы с поставщиками и процессами проработки продуктов.

---

## Архитектура

```
bot/
├── main.py              # Точка входа, настройка handlers и фоновых задач
├── config.py            # Конфигурация (.env)
├── handlers/            # Обработчики Telegram
├── services/            # Бизнес-логика
├── models/              # SQLAlchemy модели
├── keyboards/           # Telegram клавиатуры
files/                   # Шаблоны (Excel)
scripts/                 # Утилиты (connect_to_iiko.js)
```

---

## Google Sheets — Структура таблиц

### Лист: `Реестр_Поставщики`

| Колонка | Буква | Описание |
|---------|-------|----------|
| № п/п | A | Номер записи |
| ИНН | B | ИНН поставщика |
| КПП | C | КПП поставщика |
| Наименование | D | Название поставщика |
| Контактное лицо | E | ФИО контакта |
| Телефон | F | Телефон |
| Email | G | Email поставщика |
| Номенклатура | H | Название продукта |
| Ед. изм. | I | Единица измерения |
| Цена | J | Цена за единицу |
| Ссылка на папку | K | Google Drive папка |
| Статус СБ | L | Ответ службы безопасности |
| Статус ЭДО | M | Ответ от ЭДО |
| Статус Роуминг | N | Ответ на роуминг |
| Статус Документы | O | Ответ на документы |
| Дата создания | P | Дата добавления |
| Кто добавил | Q | Username добавившего |
| Тип | R | Тип поставщика |
| Код заявки | S | Уникальный код (ML-XXXXX) |
| Договор/Протокол | T | Ссылки на договор/протокол |

### Лист: `Реестр_Проработки`

| Колонка | Буква | Описание |
|---------|-------|----------|
| ID заявки | A | REQ-XXXXX |
| Дата создания | B | Дата |
| Поставщик | C | Название поставщика |
| ИНН | D | ИНН поставщика |
| Номенклатура | E | Название продукта от поставщика |
| Цена поставщика | F | Цена нового продукта |
| Ед. изм. | G | Единица измерения |
| Ссылка на сертификат | H | Google Drive ссылка |
| Ссылка на этикетку | I | Google Drive ссылка |
| Ссылка на папку | J | Google Drive папка заявки |
| Статус | K | Новая / В работе / Завершена |
| Кто занёс | L | Username создателя заявки |
| (резерв) | M-O | - |
| Кто взял в работу | P | Username взявшего заявку |
| Статус работы | Q | Статус после взятия |
| Наименование iiko | R | Выбранный продукт из iiko |
| Цена iiko | S | Средняя цена из OLAP |
| Ссылка на акт | T | Google Drive ссылка |

---

## Шаблон акта проработки

Файл: `files/ШАБЛОН АКТ ПРОРАБОТКИ.xlsx`

### Плейсхолдеры

| Плейсхолдер | Ячейка | Описание | Источник |
|-------------|--------|----------|----------|
| `{{id_item}}` | D3 | ID заявки | Реестр_Проработки.A |
| `{{user_name}}` | D2 | Кто взял в работу | Telegram username |
| `{{date}}` | C10 | Дата проработки | Текущая дата |
| `{{name_of_goods}}` | C13 | Товар поставщика | Реестр_Проработки.E |
| `{{partner}}` | C15 | Поставщик | Реестр_Проработки.C |
| `{{name_of_goods_from_iiko}}` | C18 | Продукт iiko | Выбор пользователя |
| `{{certificate}}` | C32 | Ссылка на сертификат | Реестр_Проработки.H |
| `{{OCR}}` | C33 | Ссылка на этикетку | Реестр_Проработки.I |
| `{{price_from_partner}}` | C50 | Цена поставщика | Реестр_Проработки.F |
| `{{price_from_iiko}}` | C51 | Цена из iiko | OLAP отчёт |
| `{{period_from_iiko}}` | D51 | Период расчёта цены | 7 дней по умолчанию |

---

## Модели данных (SQLite)

### User
- `telegram_id` — Telegram ID
- `company_id` — FK на Company
- `position_id` — FK на Position (опционально)
- `role` — ADMIN / EMPLOYEE
- `full_name` — Имя

### Company
- `name` — Название
- `invite_code` — Код приглашения
- `created_by` — Создатель

### CompanyIntegrations
- `company_id` — FK на Company
- `google_sheet_id` — ID Google таблицы
- `google_drive_folder_id` — ID корневой папки Drive
- `sheet_verified` — Проверен ли доступ
- `drive_verified` — Проверен ли доступ

### IikoProductCache
- `iiko_id` — ID продукта в iiko
- `name` — Название
- `name_lower` — Название в нижнем регистре (для поиска)
- `product_type` — GOODS / DISH / MODIFIER
- `main_unit` — Единица измерения
- `product_category` — Категория

### JoinRequest
- `telegram_id` — Кто подаёт заявку
- `company_id` — В какую компанию
- `status` — PENDING / APPROVED / REJECTED

---

## Сервисы

### iiko_service.py
- **Авторизация**: `_login_api()` / `_logout_api()` — обязательный flow
- **Продукты**: `get_products()` — список всех продуктов
- **Департаменты**: `get_departments()` — список департаментов
- **Фильтрация**: `get_active_ml_msk_departments()` — только "МЛ МСК" без "(закрыто)"
- **Цены**: `get_product_price()` — OLAP отчёт TRANSACTIONS
- **Синхронизация**: `sync_products_to_db()` — ежедневное обновление кеша

### act_generator.py
- **Копирование**: `copy_file_to_folder()` — копия шаблона в Drive
- **Заполнение**: `fill_act_template()` — замена плейсхолдеров через Sheets API
- **Генерация**: `generate_act()` — полный процесс

### google_sheets.py
- `get_new_development_requests()` — заявки со статусом "Новая"
- `update_development_request_for_work()` — обновление при взятии в работу
- `get_incomplete_suppliers()` — поставщики без договора
- `update_contract_info()` — запись ссылок на договор

### email_service.py
- Отправка писем через SMTP (Yandex)
- Шаблоны: СБ проверка, ЭДО, Роуминг, Документы, Договор

---

## Процессы

### 1. Регистрация пользователя
1. `/start` → показ клавиатуры
2. Присоединение по коду приглашения
3. Автоодобрение для суперадминов
4. Обычные пользователи ждут подтверждения

### 2. Добавление поставщика
1. Ввод данных (ИНН → автоподстановка через DaData)
2. Создание папки на Drive
3. Загрузка документов (сертификат, этикетка)
4. Отправка писем (СБ, ЭДО, роуминг, документы)
5. Запись в Реестр_Поставщики

### 3. Завершение заявки поставщика
1. Выбор из списка незавершённых (пустая колонка T)
2. Загрузка договора и протокола
3. Сохранение в Drive + письмо бухгалтеру
4. Обновление Реестр_Поставщики.T

### 4. Процесс проработки — Этап 1: Создание акта
1. "Выбрать заявку" → список из Реестр_Проработки (статус "Новая")
2. Поиск продукта в кеше iiko (регистронезависимый)
3. Получение цены через OLAP отчёт
4. Показ сводки: цена поставщика vs цена iiko
5. Создание акта (копия шаблона + заполнение)
6. Загрузка в папку заявки
7. Обновление Реестр_Проработки (P, Q, R, S, T)

### 5. Процесс проработки — Этап 2: Завершение (TODO)
1. "Мои заявки в работе" → список заявок со статусом "В работе"
2. Загрузка фото проработки
3. Ввод результата
4. Обновление статуса → "Завершена"
5. Отправка уведомления

---

## Фоновые задачи (APScheduler)

1. **sync_iiko_job** — синхронизация продуктов iiko (каждые 24 часа)
2. **check_email_replies** — проверка ответов на письма (каждые 5 минут)

---

## Конфигурация (.env)

```env
# Telegram
TELEGRAM_BOT_TOKEN=
SUPERADMIN_IDS=321862714

# Google
GOOGLE_DRIVE_CREDENTIALS_FILE=credentials.json
GOOGLE_DRIVE_FOLDER_ID=

# Email
SMTP_SERVER=smtp.yandex.ru
SMTP_PORT=465
SMTP_USER=
SMTP_PASSWORD=
IMAP_SERVER=imap.yandex.ru
IMAP_PORT=993

# iiko
IIKO_BASE_URL=https://mnogo-lososya-centralniy-of-co.iiko.it:443/resto/api
IIKO_LOGIN=api_reader
IIKO_PASSWORD=

# Database
DATABASE_URL=sqlite+aiosqlite:///./data/bot.db
```

---

## TODO

- [ ] Этап 2: Завершение проработки
- [ ] Заполнение всех плейсхолдеров в акте (certificate, OCR, price_from_partner, etc.)
- [ ] Разделение "Ответственный" на "Кто занёс" и "Кто взял в работу"
